<html>

<head>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js'></script>
</head>

<body>
	<canvas id="chart"></canvas>

	<script>
		var covidData = {};
		var defaultSettings = {
			spanGaps: true,
			lineTension: 0.05,
			backgroundColor: 'rgba(255, 255, 255, 0)',
		};
		var supportedStates = {
			"new south wales": {
				"label": "New South Wales",
				"borderColor": "rgb(0, 60, 255)"
			},
			"victoria": {
				"label": "Victoria",
				"borderColor": "rgb(162, 0, 255)"
			},
			"queensland": {
				"label": "Queensland",
				"borderColor": "rgb(235, 52, 52)"
			},
			"south australia": {
				"label": "South Australia",
				"borderColor": "rgb(10, 97, 0)"
			},
			"western australia": {
				"label": "Western Australia",
				"borderColor": "rgb(255, 0, 144)"
			},
			"tasmania": {
				"label": "Tasmania",
				"borderColor": "rgb(89, 255, 0)"
			},
			"northern territory": {
				"label": "Northern Territory",
				"borderColor": "rgb(0, 255, 242)"
			},
			"australian capital territory": {
				"label": "Australian Capital Territory",
				"borderColor": "rgb(235, 225, 52)"
			}
		};

		fetch('https://raw.githubusercontent.com/dylanlerch/covid-aus-data/master/data.json')
			.then(response => response.json())
			.then(data => {
				covidData = data;
				render(data);
			});

		function render(data) {
			var organisedData = organiseDataset(data);

			var newCases = getNewConfirmedCaseData(organisedData);

			renderGraph(newCases);
		}

		function organiseDataset(data) {
			var dateSet = {};
			var states = {};

			// Get a list of the supported states as an array for filtering later
			var supportedStatesArray = [];
			for (state in supportedStates) {
				supportedStatesArray.push(state);
			}

			// Filter out the states that we don't want, get the superset of all
			// of the dates of data for all states
			for (state in data.states) {
				if (supportedStatesArray.includes(state)) {
					var stateData = data.states[state];
					states[state] = stateData;

					for (entry of stateData.data) {
						dateSet[entry.date] = true;
					}
				}
			}

			// Order the dates ascending
			var dates = [];
			for (date in dateSet) {
				dates.push(date);
			}
			dates.sort((a, b) => a > b);

			// For each state, initialise empty data on each date 
			data = {}
			for (date of dates) {
				var dataForDay = {};

				for (state in states) {
					dataForDay[state] = {
						total: {
							confirmed: null,
							deaths: null,
							recovered: null
						},
						new: {
							confirmed: null,
							deaths: null,
							recovered: null
						}
					}
				}

				data[date] = dataForDay;
			}

			// Loop through the data from each of the states and  fill in the
			// empty data structure initiaised above
			for (state in states) {
				var stateData = states[state];

				for (dataForDay of stateData.data) {
					data[dataForDay.date][state].total = dataForDay.total;
					data[dataForDay.date][state].new = dataForDay.new;
				}
			}

			return data;
		}

		function getNewConfirmedCaseData(data) {
			var result = {
				labels: [],
				datasets: []
			}

			var datasets = {};
			console.log(data);

			// Add data and labels
			for (day in data) {
				result.labels.push(day);

				var dayData = data[day];

				for (state in dayData) {
					if (!datasets[state]) {
						datasets[state] = { data: [] };
					}

					var stateDayData = dayData[state];
					datasets[state].data.push(stateDayData.new.confirmed);
				}
			}

			console.log(datasets);

			// Add formatting, and push to final output
			for (datasetId in datasets) {
				var dataset = datasets[datasetId];

				dataset = {
					...defaultSettings,
					...supportedStates[datasetId],
					...dataset
				};

				result.datasets.push(dataset);
			}

			return result;
		}


		function renderGraph(data) {
			var ctx = document.getElementById('chart').getContext('2d');
			var chart = new Chart(ctx, {
				type: 'line',
				data: data,
				options: {
					aspectRatio: 5,
					legend: {
						position: 'left'
					}
				},
			});

		}
	</script>
</body>

</html>